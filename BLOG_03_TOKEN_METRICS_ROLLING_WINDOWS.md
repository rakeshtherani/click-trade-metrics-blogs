# Building Real-Time Solana DEX Analytics with ClickHouse

## Part 3: Token Metrics, Rolling Windows & ReplacingMergeTree

This part covers the TokenMetric system - 89 fields capturing real-time market data, holder distribution, risk metrics, and rolling window statistics. We also dive deep into ReplacingMergeTree for maintaining latest-state data and rolling window aggregation patterns.

---

## Table of Contents

1. [Theory: What Are Token Metrics?](#theory-what-are-token-metrics)
2. [Complete TokenMetric Fields (89 Fields)](#complete-tokenmetric-fields-89-fields)
3. [Theory: Rolling Window Aggregation](#theory-rolling-window-aggregation)
4. [Rolling Window Statistics (44 Fields)](#rolling-window-statistics-44-fields)
5. [Theory: Risk Metrics & Detection](#theory-risk-metrics--detection)
6. [Risk Metrics Deep Dive (20 Fields)](#risk-metrics-deep-dive-20-fields)
7. [Theory: Pro Trader Detection](#theory-pro-trader-detection)
8. [Pro Trader Metrics (5 Fields)](#pro-trader-metrics-5-fields)
9. [ClickHouse Deep Dive: ReplacingMergeTree](#clickhouse-deep-dive-replacingmergetree)
10. [ClickHouse Pattern: Current State vs History](#clickhouse-pattern-current-state-vs-history)
11. [Complete DDL: Token Metrics](#complete-ddl-token-metrics)
12. [Materialized Views & Fan-Out](#materialized-views--fan-out)
13. [Query Patterns & Performance](#query-patterns--performance)
14. [Metrics Summary](#metrics-summary)

---

## Theory: What Are Token Metrics?

### The Problem: Real-Time Token Analytics

Users need instant answers to questions like:
- What's the current price of BONK?
- How much has it changed in the last 5 minutes? 1 hour? 24 hours?
- What % is held by top 10 wallets?
- Are there snipers/bundlers holding this token?
- Is this token safe to trade?

### Two Approaches to Solving This

**Approach 1: Query-Time Aggregation (Slow)**
```sql
-- Calculate 24h stats at query time
SELECT
    token_mint,
    (max(price) - min(price)) / min(price) AS price_change_24h,
    sum(volume) AS volume_24h,
    count() AS trades_24h
FROM trades
WHERE token_mint = 'X' AND time > now() - INTERVAL 24 HOUR
GROUP BY token_mint;
-- Problem: 10,000+ tokens × 24h data = SLOW
```

**Approach 2: Pre-Computed Rolling Windows (Fast)**
```sql
-- Read pre-computed stats instantly
SELECT * FROM token_metrics
WHERE token_mint = 'X';
-- Returns: price, volume_24h, trades_24h, etc. in < 10ms
```

We use **Approach 2**: The DataStreams pipeline maintains rolling window state and emits pre-computed `TokenMetric` events.

### How Rolling Windows Work

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ROLLING WINDOW PIPELINE                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  1-minute OHLCV candles flow continuously:                              │
│                                                                          │
│  [C1][C2][C3][C4][C5]...[C295][C296][C297][C298][C299][C300]            │
│                         ◄────────── 5-hour window ────────────►         │
│                                                                          │
│  When C301 arrives:                                                      │
│  - Add C301 to window                                                    │
│  - Remove C1 from window (it's now > 5 hours old)                       │
│  - Recalculate aggregates:                                              │
│    • volume_5h = sum(C2...C301)                                         │
│    • price_change_5h = (C301.close - C2.open) / C2.open                │
│                                                                          │
│  Window Hierarchy:                                                       │
│  ├── 1m candles ──► 5-minute rolling window                             │
│  ├── 5m candles ──► 1-hour rolling window                               │
│  ├── 30m candles ──► 6-hour rolling window                              │
│  └── 1h candles ──► 24-hour rolling window ──► Emit TokenMetric         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Data Pipeline: Token Metrics Generation

### How TokenMetrics Are Generated in DataStreams

TokenMetrics are generated by aggregating OHLCV candles over rolling windows:

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    TOKEN METRICS GENERATION PIPELINE                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  INPUT: Token OHLCV Candles (from OHLCV transforms)                             │
│  ├── solana.token_ohlcv.1m  (1-minute candles)                                  │
│  ├── solana.token_ohlcv.5m  (5-minute candles)                                  │
│  └── solana.token_ohlcv.1h  (1-hour candles)                                    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │                    TRANSFORM: token_metrics_emitter                          ││
│  │                                                                              ││
│  │  Pipeline: token_prices                                                      ││
│  │  Source: solana.token_ohlcv.1h (triggered on every 1h candle)               ││
│  │  Partition By: token_mint                                                    ││
│  │                                                                              ││
│  │  ┌───────────────────────────────────────────────────────────────────────┐  ││
│  │  │ STEP 1: Load Token State                                               │  ││
│  │  │ ├─ context.state.get::<TokenRollingState>(token_mint)                 │  ││
│  │  │ └─ Contains: ring buffers for each window, risk metrics, trader counts│  ││
│  │  └───────────────────────────────────────────────────────────────────────┘  ││
│  │                                                                              ││
│  │  ┌───────────────────────────────────────────────────────────────────────┐  ││
│  │  │ STEP 2: Update Rolling Windows                                         │  ││
│  │  │                                                                        │  ││
│  │  │ 5m Window (5 × 1-minute candles):                                     │  ││
│  │  │ ├─ Push new 1m candle to ring buffer                                  │  ││
│  │  │ ├─ Pop oldest candle if buffer full                                   │  ││
│  │  │ └─ Recalculate: volume_5m, price_change_5m, buys_5m, sells_5m        │  ││
│  │  │                                                                        │  ││
│  │  │ 1h Window (12 × 5-minute candles):                                    │  ││
│  │  │ ├─ Push new 5m candle to ring buffer                                  │  ││
│  │  │ └─ Recalculate: volume_1h, price_change_1h, buys_1h, sells_1h        │  ││
│  │  │                                                                        │  ││
│  │  │ 6h Window (6 × 1-hour candles):                                       │  ││
│  │  │ └─ Recalculate: volume_6h, price_change_6h, ...                       │  ││
│  │  │                                                                        │  ││
│  │  │ 24h Window (24 × 1-hour candles):                                     │  ││
│  │  │ └─ Recalculate: volume_24h, price_change_24h, ...                     │  ││
│  │  └───────────────────────────────────────────────────────────────────────┘  ││
│  │                                                                              ││
│  │  ┌───────────────────────────────────────────────────────────────────────┐  ││
│  │  │ STEP 3: Aggregate Risk Metrics (from state)                            │  ││
│  │  │ ├─ bundler_pct: Sum holdings of wallets flagged as bundlers           │  ││
│  │  │ ├─ snipers_pct: Sum holdings of wallets flagged as snipers            │  ││
│  │  │ ├─ insiders_pct: Sum holdings of wallets funded by deployer           │  ││
│  │  │ └─ rug_risk_pct: Composite score calculation                          │  ││
│  │  └───────────────────────────────────────────────────────────────────────┘  ││
│  │                                                                              ││
│  │  ┌───────────────────────────────────────────────────────────────────────┐  ││
│  │  │ STEP 4: Aggregate Pro Trader Metrics                                   │  ││
│  │  │ ├─ Scan all trades in window for platform fee wallet matches          │  ││
│  │  │ ├─ Count unique traders per platform                                  │  ││
│  │  │ └─ Calculate pro_trader_pct = pro_count / total_count × 100          │  ││
│  │  └───────────────────────────────────────────────────────────────────────┘  ││
│  │                                                                              ││
│  │  ┌───────────────────────────────────────────────────────────────────────┐  ││
│  │  │ STEP 5: Emit TokenMetric                                               │  ││
│  │  │ └─ context.emit("solana.token_metrics.v2", token_metric)              │  ││
│  │  └───────────────────────────────────────────────────────────────────────┘  ││
│  │                                                                              ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
│                                                                                  │
│  OUTPUT: solana.token_metrics.v2 (89 fields per token, emitted every 1h candle) │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### State Management for Rolling Windows

The rolling window state is the most complex state structure in the system:

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    TOKEN ROLLING STATE STRUCTURE                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  #[derive(AnyState, Serialize, Deserialize)]                                    │
│  pub struct TokenRollingState {                                                 │
│                                                                                  │
│    // ═══════════════════════════════════════════════════════════════════════  │
│    // RING BUFFERS FOR ROLLING WINDOWS                                          │
│    // ═══════════════════════════════════════════════════════════════════════  │
│                                                                                  │
│    candles_1m: VecDeque<OhlcvCandle>,  // Last 5 for 5m window                 │
│    candles_5m: VecDeque<OhlcvCandle>,  // Last 12 for 1h window                │
│    candles_1h: VecDeque<OhlcvCandle>,  // Last 24 for 24h window               │
│                                                                                  │
│    // ═══════════════════════════════════════════════════════════════════════  │
│    // TRADER TRACKING (for pro trader detection)                                │
│    // ═══════════════════════════════════════════════════════════════════════  │
│                                                                                  │
│    all_traders: HashSet<String>,           // Unique wallets                   │
│    pro_traders: HashMap<String, String>,   // wallet -> platform               │
│    platform_counts: HashMap<String, u64>,  // platform -> trader count         │
│                                                                                  │
│    // ═══════════════════════════════════════════════════════════════════════  │
│    // RISK WALLET TRACKING                                                      │
│    // ═══════════════════════════════════════════════════════════════════════  │
│                                                                                  │
│    bundler_wallets: Vec<(String, Decimal)>,  // (wallet, holdings)             │
│    sniper_wallets: Vec<(String, Decimal)>,   // (wallet, holdings)             │
│    insider_wallets: Vec<(String, Decimal)>,  // (wallet, holdings)             │
│                                                                                  │
│    // ═══════════════════════════════════════════════════════════════════════  │
│    // TOKEN METADATA (from token creation event)                                │
│    // ═══════════════════════════════════════════════════════════════════════  │
│                                                                                  │
│    creator: String,                        // Deployer wallet                   │
│    created_slot: u64,                      // For sniper window detection       │
│    supply: Decimal,                        // For percentage calculations       │
│    primary_market: String,                 // Highest liquidity pool            │
│    primary_dex: String,                    // DEX of primary market             │
│                                                                                  │
│  }                                                                              │
│                                                                                  │
│  Memory per token: ~2-5 KB (depending on trader/wallet list sizes)              │
│  Total for 10K active tokens: ~20-50 MB                                         │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Risk Detection Pipeline (Integrated with Trade Processing)

Risk wallets are detected during trade processing, not during metrics emission:

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    RISK DETECTION FLOW                                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  When a trade arrives (solana.trades.v2):                                       │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │ BUNDLER DETECTION                                                            ││
│  │ ├─ Check if trade.slot == token.created_slot (same block as creation)       ││
│  │ ├─ Check if trade is in same Jito bundle as token creation                  ││
│  │ └─ If yes → Add trader to bundler_wallets with their holdings               ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │ SNIPER DETECTION                                                             ││
│  │ ├─ Check if trade.slot <= token.created_slot + SNIPER_WINDOW (5 slots)      ││
│  │ ├─ Check if trade.direction == Buy                                          ││
│  │ └─ If yes → Add trader to sniper_wallets with their holdings                ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │ INSIDER DETECTION                                                            ││
│  │ ├─ Check if trader received SOL from token.creator (funding graph)          ││
│  │ ├─ Check if trade.slot <= token.created_slot + INSIDER_WINDOW (1 hour)      ││
│  │ └─ If yes → Add trader to insider_wallets with their holdings               ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │ PRO TRADER DETECTION                                                         ││
│  │ ├─ Scan SOL transfers in transaction                                        ││
│  │ ├─ Match against PLATFORM_FEE_WALLETS (51 known wallets)                    ││
│  │ │   Axiom: ["3f7E8VK...", "Cw8CFy...", ...]                                 ││
│  │ │   Trojan: ["7xKXtg...", ...]                                              ││
│  │ │   BullX: ["9pQRSt...", ...]                                               ││
│  │ │   ... (15+ platforms)                                                      ││
│  │ └─ If match → Add trader to pro_traders with platform name                  ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
│                                                                                  │
│  When TokenMetric is emitted:                                                   │
│  ├─ bundler_pct = sum(bundler_holdings) / token_supply × 100                   │
│  ├─ sniper_pct = sum(sniper_holdings) / token_supply × 100                     │
│  ├─ insider_pct = sum(insider_holdings) / token_supply × 100                   │
│  └─ pro_trader_pct = pro_traders.len() / all_traders.len() × 100               │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### ClickHouse Ingestion for Token Metrics

```sql
-- NATS Engine subscribes to token metrics
CREATE TABLE datastreams.token_metrics_queue (
    token_mint String,
    token_name String,
    token_symbol String,
    price_sol Decimal(38, 18),
    price_usd Decimal(38, 18),
    market_cap_sol Decimal(38, 18),
    market_cap_usd Decimal(38, 18),
    liquidity_sol Decimal(38, 18),
    liquidity_usd Decimal(38, 18),
    supply Decimal(38, 18),
    primary_market String,
    primary_dex String,
    top10_holdings_pct Decimal(38, 18),
    holders_count UInt64,
    dev_holdings_pct Decimal(38, 18),
    bundler_pct Decimal(38, 18),
    snipers_pct Decimal(38, 18),
    insiders_pct Decimal(38, 18),
    bundler_wallets Array(String),
    sniper_wallets Array(String),
    insider_wallets Array(String),
    -- ... all 89 fields in exact struct order
    last_updated DateTime64(9)
)
ENGINE = NATS
SETTINGS
    nats_url = 'nats://nats:4222',
    nats_subjects = 'solana.token_metrics.v2',
    nats_format = 'RowBinary',
    nats_num_consumers = 2;

-- Fan-out to current state (ReplacingMergeTree) and history (MergeTree)
CREATE MATERIALIZED VIEW datastreams.token_metrics_current_mv
TO datastreams.token_metrics AS
SELECT * FROM datastreams.token_metrics_queue;

CREATE MATERIALIZED VIEW datastreams.token_metrics_history_mv
TO datastreams.token_metrics_history AS
SELECT
    token_mint, token_symbol, price_sol, price_usd,
    market_cap_usd, liquidity_usd, holders_count,
    top10_holdings_pct, bundler_pct, snipers_pct, insiders_pct,
    rug_risk_pct, stats_24h_volume_usd, stats_24h_price_change_pct,
    last_updated
FROM datastreams.token_metrics_queue;
```

---

## Complete TokenMetric Fields (89 Fields)

### Category 1: Basic Token Info (3 fields)

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `token_mint` | String | Token mint address (primary key) | `"DezXAZ8z7..."` |
| `token_name` | String | Token name from Metaplex | `"Bonk"` |
| `token_symbol` | String | Token ticker symbol | `"BONK"` |

### Category 2: Current Market Data (7 fields)

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `price_sol` | Decimal(38,18) | Current price in SOL | `0.00000001` |
| `price_usd` | Decimal(38,18) | Current price in USD | `0.0000015` |
| `market_cap_sol` | Decimal(38,18) | Market cap in SOL | `93450.5` |
| `market_cap_usd` | Decimal(38,18) | Market cap in USD | `14017575.0` |
| `liquidity_sol` | Decimal(38,18) | Total liquidity across pools (SOL) | `10000.0` |
| `liquidity_usd` | Decimal(38,18) | Total liquidity across pools (USD) | `1500000.0` |
| `supply` | Decimal(38,18) | Total token supply | `9345000000000.0` |

### Category 3: Primary Market Info (2 fields)

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `primary_market` | String | Pool address with highest liquidity | `"58oQChx..."` |
| `primary_dex` | LowCardinality(String) | DEX of primary market | `"raydium"` |

### Category 4: Holder Metrics (3 fields)

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `top10_holdings_pct` | Decimal(38,18) | % of supply held by top 10 wallets | `45.5` |
| `holders_count` | UInt64 | Total unique holder count | `15234` |
| `dev_holdings_pct` | Decimal(38,18) | % held by token creator | `5.2` |

### Category 5: Risk Wallet Metrics (7 fields)

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `bundler_pct` | Decimal(38,18) | % held by bundler wallets | `2.1` |
| `snipers_pct` | Decimal(38,18) | % held by sniper wallets | `8.5` |
| `insiders_pct` | Decimal(38,18) | % held by insider wallets | `3.2` |
| `bundler_wallets` | Array(String) | List of detected bundler wallets | `["ABC...", "DEF..."]` |
| `sniper_wallets` | Array(String) | List of detected sniper wallets | `["GHI...", "JKL..."]` |
| `insider_wallets` | Array(String) | List of detected insider wallets | `["MNO...", "PQR..."]` |
| `phishing_pct` | Decimal(38,18) | % held by known phishing wallets | `0.5` |

### Category 6: Token Risk Flags (5 fields)

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `dex_paid` | Bool | Whether DEX listing fee was paid | `true` |
| `no_mint` | Bool | Mint authority disabled (safe) | `true` |
| `burnt_pct` | Decimal(38,18) | % of LP tokens burned | `95.5` |
| `rug_risk_pct` | Decimal(38,18) | Composite rug pull risk score (0-100) | `15.0` |
| `blacklist_risk_pct` | Decimal(38,18) | % supply held by blacklisted wallets | `1.2` |

### Category 7: Token Blacklist (2 fields)

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `is_blacklisted` | Bool | Token itself is flagged malicious | `false` |
| `blacklist_source` | Nullable(String) | Source of blacklist flag | `"goplus"`, `"rugcheck"` |

### Category 8: Liquidity Risk Components (3 fields)

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `lp_lock_pct` | Decimal(38,18) | % of LP tokens locked | `80.0` |
| `lp_burn_pct` | Decimal(38,18) | % of LP tokens burned | `15.0` |
| `lp_removable` | Bool | Can deployer remove liquidity? | `false` |

### Category 9: Contract Risk Flags (3 fields)

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `has_freeze_authority` | Bool | Token can freeze wallets | `false` |
| `has_mint_authority` | Bool | Creator can mint more tokens | `false` |
| `is_honeypot` | Bool | Token detected as honeypot | `false` |

### Category 10: Fee Tracking (6 fields)

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `total_transaction_fees_sol` | Decimal(38,18) | Lifetime transaction fees | `125.5` |
| `total_priority_fees_sol` | Decimal(38,18) | Lifetime priority fees | `45.2` |
| `total_dex_fees_sol` | Decimal(38,18) | Lifetime DEX fees (per-hop) | `890.1` |
| `total_validator_tips_sol` | Decimal(38,18) | Lifetime MEV tips (Jito) | `32.5` |
| `total_platform_fees_sol` | Decimal(38,18) | Lifetime platform fees (bots) | `156.8` |
| `total_fees_paid_sol` | Decimal(38,18) | Total: all fee categories | `1250.1` |

### Category 11: Pro Trader Metrics (5 fields)

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `total_trader_count` | UInt64 | All unique traders | `5234` |
| `pro_trader_count` | UInt64 | Traders using platforms | `1523` |
| `pro_trader_pct` | Decimal(38,18) | Pro trader percentage | `29.1` |
| `platforms_used` | Array(String) | Platform names | `["Axiom", "Trojan", "BullX"]` |
| `platform_trader_counts` | Array(UInt64) | Traders per platform | `[523, 412, 289]` |

### Category 12-15: Rolling Window Stats (44 fields)

**4 timeframes × 11 fields each = 44 fields**

See detailed breakdown in next section.

### Category 16: Timestamp (1 field)

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `last_updated` | DateTime64(9) | Last update timestamp | `2024-01-15 10:30:45.123456789` |

---

## Rolling Window Statistics (44 Fields)

### Per-Window Fields (11 fields × 4 windows)

Each rolling window (5m, 1h, 6h, 24h) has identical fields:

| Field Pattern | Type | Description |
|---------------|------|-------------|
| `stats_{window}_price_change_pct` | Decimal(38,18) | Price change % over window |
| `stats_{window}_volume_sol` | Decimal(38,18) | Total volume in SOL |
| `stats_{window}_volume_usd` | Decimal(38,18) | Total volume in USD |
| `stats_{window}_buys_count` | UInt64 | Number of buy trades |
| `stats_{window}_buys_volume_sol` | Decimal(38,18) | Buy volume in SOL |
| `stats_{window}_buys_volume_usd` | Decimal(38,18) | Buy volume in USD |
| `stats_{window}_sells_count` | UInt64 | Number of sell trades |
| `stats_{window}_sells_volume_sol` | Decimal(38,18) | Sell volume in SOL |
| `stats_{window}_sells_volume_usd` | Decimal(38,18) | Sell volume in USD |
| `stats_{window}_net_volume_sol` | Decimal(38,18) | Net volume (buys - sells) SOL |
| `stats_{window}_net_volume_usd` | Decimal(38,18) | Net volume (buys - sells) USD |

### Complete Field List by Window

**5-Minute Window (11 fields)**
```
stats_5m_price_change_pct    stats_5m_volume_sol
stats_5m_volume_usd          stats_5m_buys_count
stats_5m_buys_volume_sol     stats_5m_buys_volume_usd
stats_5m_sells_count         stats_5m_sells_volume_sol
stats_5m_sells_volume_usd    stats_5m_net_volume_sol
stats_5m_net_volume_usd
```

**1-Hour Window (11 fields)**
```
stats_1h_price_change_pct    stats_1h_volume_sol
stats_1h_volume_usd          stats_1h_buys_count
stats_1h_buys_volume_sol     stats_1h_buys_volume_usd
stats_1h_sells_count         stats_1h_sells_volume_sol
stats_1h_sells_volume_usd    stats_1h_net_volume_sol
stats_1h_net_volume_usd
```

**6-Hour Window (11 fields)**
```
stats_6h_price_change_pct    stats_6h_volume_sol
stats_6h_volume_usd          stats_6h_buys_count
stats_6h_buys_volume_sol     stats_6h_buys_volume_usd
stats_6h_sells_count         stats_6h_sells_volume_sol
stats_6h_sells_volume_usd    stats_6h_net_volume_sol
stats_6h_net_volume_usd
```

**24-Hour Window (11 fields)**
```
stats_24h_price_change_pct   stats_24h_volume_sol
stats_24h_volume_usd         stats_24h_buys_count
stats_24h_buys_volume_sol    stats_24h_buys_volume_usd
stats_24h_sells_count        stats_24h_sells_volume_sol
stats_24h_sells_volume_usd   stats_24h_net_volume_sol
stats_24h_net_volume_usd
```

---

## Theory: Risk Metrics & Detection

### Sniper Detection

**Definition:** Wallets that buy tokens within the first few blocks of launch, before others can react.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       SNIPER DETECTION                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Token Creation:  Slot 100,000,000                                      │
│                                                                          │
│  Sniper Window:   Slot 100,000,000 to 100,000,005 (5 slots = ~2.5s)    │
│                                                                          │
│  Detection Criteria:                                                     │
│  ├── Bought in sniper window                                            │
│  ├── Still holds tokens (didn't sell all)                               │
│  └── Holdings > 0.1% of supply                                          │
│                                                                          │
│  Risk Indicator:                                                         │
│  └── High sniper % = Token may have been "sniped" by insiders          │
│      with advance knowledge of launch                                    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Bundler Detection

**Definition:** Wallets that bought tokens in the same transaction bundle as token creation (MEV bundling).

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       BUNDLER DETECTION                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Jito Bundle:                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ TX 1: Create Token (deployer)                                    │   │
│  │ TX 2: Create Pool (deployer)                                     │   │
│  │ TX 3: Buy Token (wallet A) ← BUNDLER                             │   │
│  │ TX 4: Buy Token (wallet B) ← BUNDLER                             │   │
│  │ TX 5: Buy Token (wallet C) ← BUNDLER                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  Detection Criteria:                                                     │
│  ├── Transaction in same Jito bundle as token creation                  │
│  ├── Bought before any other trades could execute                       │
│  └── Often controlled by deployer (multiple wallets)                    │
│                                                                          │
│  Risk Indicator:                                                         │
│  └── High bundler % = Deployer likely controls significant supply       │
│      via multiple wallets                                                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Insider Detection

**Definition:** Wallets connected to the deployer through funding relationships or coordinated activity.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       INSIDER DETECTION                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Funding Graph:                                                         │
│                                                                          │
│          ┌─────────┐                                                    │
│          │ Deployer│                                                    │
│          └────┬────┘                                                    │
│     ┌─────────┼─────────┐                                               │
│     ▼         ▼         ▼                                               │
│  ┌──────┐ ┌──────┐ ┌──────┐                                            │
│  │Wallet│ │Wallet│ │Wallet│  ← Funded by deployer                      │
│  │  A   │ │  B   │ │  C   │                                            │
│  └──────┘ └──────┘ └──────┘                                            │
│                                                                          │
│  Detection Criteria:                                                     │
│  ├── Received SOL from deployer wallet (directly or 1-hop)              │
│  ├── Bought tokens within first hour of launch                          │
│  └── Holdings > 0.5% of supply                                          │
│                                                                          │
│  Risk Indicator:                                                         │
│  └── High insider % = Coordinated wallets may dump simultaneously       │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Rug Risk Score Calculation

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    RUG RISK SCORE (0-100%)                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Formula:                                                                │
│                                                                          │
│  rug_risk_pct = (dev_holdings_pct × 0.35)     -- Developer risk         │
│               + (insider_pct × 0.25)           -- Insider risk          │
│               + (liquidity_risk × 0.25)        -- Liquidity risk        │
│               + (contract_risk × 0.15)         -- Contract risk         │
│                                                                          │
│  Where:                                                                  │
│                                                                          │
│  liquidity_risk = (lock_score × 0.4)          -- LP locking            │
│                 + (removable × 0.3)            -- Can remove LP?        │
│                 + (low_liq × 0.3)              -- < $10K liquidity?     │
│                                                                          │
│  contract_risk = has_mint_authority × 33                                │
│                + has_freeze_authority × 33                               │
│                + is_honeypot × 34                                        │
│                                                                          │
│  Risk Tiers:                                                             │
│  ├── 0-20%:   LOW RISK (green)                                          │
│  ├── 20-50%:  MEDIUM RISK (yellow)                                      │
│  ├── 50-80%:  HIGH RISK (orange)                                        │
│  └── 80-100%: EXTREME RISK (red)                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Risk Metrics Deep Dive (20 Fields)

### Risk Wallet Tracking (7 fields)

| Field | Detection Method | Risk Implication |
|-------|------------------|------------------|
| `bundler_pct` | Same bundle as token creation | Deployer controls supply |
| `snipers_pct` | Bought in first 5 slots | Advance knowledge |
| `insiders_pct` | Funded by deployer | Coordinated selling |
| `bundler_wallets` | Array of addresses | For detailed analysis |
| `sniper_wallets` | Array of addresses | For detailed analysis |
| `insider_wallets` | Array of addresses | For detailed analysis |
| `phishing_pct` | Known phishing wallet list | Compromised funds |

### Token-Level Risk Flags (8 fields)

| Field | What It Means | Safe Value |
|-------|---------------|------------|
| `dex_paid` | DEX listing fee paid | `true` |
| `no_mint` | Cannot mint more tokens | `true` |
| `burnt_pct` | LP burned (irrevocable) | `> 90%` |
| `rug_risk_pct` | Composite risk score | `< 20%` |
| `blacklist_risk_pct` | % held by bad wallets | `< 5%` |
| `lp_lock_pct` | LP locked (time-locked) | `> 80%` |
| `lp_removable` | Deployer can pull LP | `false` |
| `is_blacklisted` | Token flagged malicious | `false` |

### Contract Risk Flags (5 fields)

| Field | What It Means | Safe Value |
|-------|---------------|------------|
| `has_freeze_authority` | Can freeze wallets | `false` |
| `has_mint_authority` | Can mint more tokens | `false` |
| `is_honeypot` | Cannot sell | `false` |
| `blacklist_source` | Who flagged it | `null` |
| `lp_burn_pct` | % of LP burned | `> 90%` |

---

## Theory: Pro Trader Detection

### What Are "Pro Traders"?

Traders using specialized trading bots/platforms:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    PRO TRADER PLATFORMS                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Platform        │ Fee Wallets │ Typical Fee │ Use Case                 │
│  ────────────────┼─────────────┼─────────────┼────────────────────────  │
│  Axiom           │ 20 wallets  │ 0.5%        │ Fast trading, sniping    │
│  Trojan          │ 7 wallets   │ 0.5-1%      │ MEV protection           │
│  BullX           │ 4 wallets   │ 0.75%       │ Copy trading             │
│  Bloom           │ 3 wallets   │ 0.5%        │ Portfolio tracking       │
│  BONKbot         │ 2 wallets   │ 1%          │ Telegram trading         │
│  Photon          │ 3 wallets   │ 0.9%        │ Fast execution           │
│  GMGN            │ 2 wallets   │ 0.8%        │ Analytics + trading      │
│  Maestro         │ 3 wallets   │ 1%          │ Multi-chain bots         │
│  PepeBoost       │ 2 wallets   │ 0.5%        │ Memecoin sniping         │
│  ... (15+ more)  │ ...         │ ...         │ ...                      │
│                                                                          │
│  Total: 51 known fee wallets across 15+ platforms                       │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Detection Method

```
Transaction containing trade:
┌─────────────────────────────────────────────────────────────────────────┐
│ Instructions:                                                            │
│ ├── [0] ComputeBudget.SetComputeUnitLimit                               │
│ ├── [1] ComputeBudget.SetComputeUnitPrice                               │
│ ├── [2] Raydium.Swap (the actual trade)                                 │
│ ├── [3] System.Transfer: 0.005 SOL to "3f7E8VK..." ← AXIOM FEE WALLET  │
│ └── [4] System.Transfer: 0.001 SOL to "Cw8CFyM..." ← JITO TIP          │
└─────────────────────────────────────────────────────────────────────────┘

Detection:
1. Scan all SOL transfers in transaction
2. Match destination against PLATFORM_FEE_WALLETS constant
3. If match found → trader is using that platform
4. Increment pro_trader_count, update platforms_used array
```

### Why It Matters

**High pro_trader_pct indicates:**
- Sophisticated traders are active
- Token has "smart money" interest
- Likely higher volume and liquidity
- May indicate upcoming volatility

**Low pro_trader_pct indicates:**
- Mostly retail/organic traders
- Less MEV competition
- May be overlooked opportunity

---

## Pro Trader Metrics (5 Fields)

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `total_trader_count` | UInt64 | All unique wallets that traded this token | `5234` |
| `pro_trader_count` | UInt64 | Unique wallets using known platforms | `1523` |
| `pro_trader_pct` | Decimal | `(pro / total) × 100` | `29.1%` |
| `platforms_used` | Array(String) | Platform names detected | `["Axiom", "Trojan", "BullX"]` |
| `platform_trader_counts` | Array(UInt64) | Traders per platform (parallel array) | `[523, 412, 289]` |

### Example Query: Platform Breakdown

```sql
SELECT
    token_symbol,
    total_trader_count,
    pro_trader_count,
    pro_trader_pct,
    arrayZip(platforms_used, platform_trader_counts) AS platform_breakdown
FROM token_metrics FINAL
WHERE stats_24h_volume_usd > 100000
ORDER BY pro_trader_pct DESC
LIMIT 20;
```

---

## ClickHouse Deep Dive: ReplacingMergeTree

### The Problem: Maintaining Latest State

TokenMetrics is updated frequently (every 1h candle). We need:
- Latest state per token (not history of all updates)
- Fast point lookups by token_mint
- Automatic deduplication

### Theory: How ReplacingMergeTree Works

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ReplacingMergeTree Mechanics                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Initial inserts (3 updates for token BONK):                            │
│                                                                          │
│  Part 1:  BONK, price=0.00001, version=100                              │
│  Part 2:  BONK, price=0.00002, version=200                              │
│  Part 3:  BONK, price=0.000015, version=300                             │
│                                                                          │
│  Before merge:                                                           │
│  SELECT * FROM token_metrics WHERE token='BONK';                        │
│  → Returns 3 rows (all versions)                                        │
│                                                                          │
│  After merge (background):                                               │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │ BONK, price=0.000015, version=300  ← Only highest version kept     │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  SELECT * FROM token_metrics WHERE token='BONK';                        │
│  → Returns 1 row (latest only)                                          │
│                                                                          │
│  IMPORTANT: Use FINAL to force deduplication at query time:             │
│  SELECT * FROM token_metrics FINAL WHERE token='BONK';                  │
│  → Always returns 1 row (even before merge)                             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Version Column Strategy

```sql
-- Option 1: Use timestamp as version (nanosecond precision)
ENGINE = ReplacingMergeTree(version)
-- Where: version UInt64 MATERIALIZED toUnixTimestamp64Nano(last_updated)

-- Option 2: Use explicit version counter
ENGINE = ReplacingMergeTree(version)
-- Where: version UInt64 (incremented by application)

-- Option 3: No version (uses insert order, less reliable)
ENGINE = ReplacingMergeTree()
```

We use **Option 1**: Nanosecond timestamp guarantees latest update wins.

### FINAL Keyword Performance

```sql
-- Without FINAL: May return duplicates
SELECT * FROM token_metrics
WHERE token_mint = 'ABC...';
-- Fast, but potentially multiple rows per token

-- With FINAL: Deduplicates at query time
SELECT * FROM token_metrics FINAL
WHERE token_mint = 'ABC...';
-- Slightly slower, guaranteed one row per token

-- Alternative: Subquery pattern
SELECT * FROM (
    SELECT *, row_number() OVER (PARTITION BY token_mint ORDER BY version DESC) AS rn
    FROM token_metrics
    WHERE token_mint = 'ABC...'
) WHERE rn = 1;
-- More flexible, useful for complex queries
```

### When Merges Happen

```
Background merge conditions:
├── Automatic: Parts accumulate, ClickHouse merges
├── Scheduled: merge_selector runs periodically
└── Manual: OPTIMIZE TABLE token_metrics FINAL

Merge frequency factors:
├── Part size (larger parts = less frequent)
├── Total parts count (more parts = more urgent)
├── Server load
└── merge_with_ttl_timeout setting
```

---

## ClickHouse Pattern: Current State vs History

### Dual-Table Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    CURRENT STATE + HISTORY PATTERN                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  NATS Queue (token_metrics_queue)                                       │
│              │                                                           │
│              ├──────────────────────────────────────────────┐           │
│              │                                              │           │
│              ▼                                              ▼           │
│  ┌─────────────────────────┐          ┌─────────────────────────────┐  │
│  │    token_metrics        │          │    token_metrics_history    │  │
│  │  (ReplacingMergeTree)   │          │       (MergeTree)           │  │
│  ├─────────────────────────┤          ├─────────────────────────────┤  │
│  │ ORDER BY (token_mint)   │          │ ORDER BY (token_mint,       │  │
│  │                         │          │           last_updated)     │  │
│  │ One row per token       │          │ All historical snapshots    │  │
│  │ (latest version)        │          │ (time-series)               │  │
│  │                         │          │                             │  │
│  │ Use case:               │          │ Use case:                   │  │
│  │ - Current price lookup  │          │ - Price history charts      │  │
│  │ - Risk score check      │          │ - Holder growth analysis    │  │
│  │ - API responses         │          │ - Trend detection           │  │
│  └─────────────────────────┘          └─────────────────────────────┘  │
│                                                                          │
│  Storage characteristics:                                                │
│  - Current: ~10K tokens × 1 row = ~10K rows                             │
│  - History: ~10K tokens × 24 updates/day × 90 days = ~21M rows         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Fan-Out Materialized View Pattern

```sql
-- Single queue, multiple destinations
CREATE MATERIALIZED VIEW token_metrics_current_mv TO token_metrics
AS SELECT * FROM token_metrics_queue;

CREATE MATERIALIZED VIEW token_metrics_history_mv TO token_metrics_history
AS SELECT
    -- Subset of fields for history (save storage)
    token_mint, token_symbol, price_sol, price_usd,
    market_cap_usd, liquidity_usd, holders_count,
    stats_24h_volume_usd, stats_24h_price_change_pct,
    last_updated
FROM token_metrics_queue;
```

---

## Complete DDL: Token Metrics

```sql
-- ════════════════════════════════════════════════════════════════════════════
-- TOKEN METRICS - CURRENT STATE
-- Purpose: Latest metrics for each token (real-time lookups)
-- Engine: ReplacingMergeTree for automatic deduplication
-- ════════════════════════════════════════════════════════════════════════════

CREATE TABLE datastreams.token_metrics ON CLUSTER '{cluster}'
(
    -- ════════════════════════════════════════════════════════════════════════
    -- BASIC TOKEN INFO (3 fields)
    -- ════════════════════════════════════════════════════════════════════════
    token_mint String CODEC(ZSTD(3)) COMMENT 'Token mint address (primary key)',
    token_name String CODEC(ZSTD(3)) COMMENT 'Token name from Metaplex',
    token_symbol String CODEC(ZSTD(3)) COMMENT 'Token ticker symbol',

    -- ════════════════════════════════════════════════════════════════════════
    -- CURRENT MARKET DATA (7 fields)
    -- ════════════════════════════════════════════════════════════════════════
    price_sol Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Current price in SOL',
    price_usd Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Current price in USD',
    market_cap_sol Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Market cap in SOL',
    market_cap_usd Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Market cap in USD',
    liquidity_sol Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Total liquidity SOL',
    liquidity_usd Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Total liquidity USD',
    supply Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Total token supply',

    -- ════════════════════════════════════════════════════════════════════════
    -- PRIMARY MARKET INFO (2 fields)
    -- ════════════════════════════════════════════════════════════════════════
    primary_market String CODEC(ZSTD(3)) COMMENT 'Highest liquidity pool address',
    primary_dex LowCardinality(String) COMMENT 'DEX of primary market',

    -- ════════════════════════════════════════════════════════════════════════
    -- HOLDER METRICS (3 fields)
    -- ════════════════════════════════════════════════════════════════════════
    top10_holdings_pct Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Top 10 holders %',
    holders_count UInt64 CODEC(T64, LZ4) COMMENT 'Total holder count',
    dev_holdings_pct Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Developer holdings %',

    -- ════════════════════════════════════════════════════════════════════════
    -- RISK WALLET METRICS (7 fields)
    -- ════════════════════════════════════════════════════════════════════════
    bundler_pct Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Bundler holdings %',
    snipers_pct Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Sniper holdings %',
    insiders_pct Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Insider holdings %',
    bundler_wallets Array(String) COMMENT 'Bundler wallet addresses',
    sniper_wallets Array(String) COMMENT 'Sniper wallet addresses',
    insider_wallets Array(String) COMMENT 'Insider wallet addresses',
    phishing_pct Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Phishing wallet holdings %',

    -- ════════════════════════════════════════════════════════════════════════
    -- TOKEN RISK FLAGS (5 fields)
    -- ════════════════════════════════════════════════════════════════════════
    dex_paid Bool COMMENT 'DEX listing fee paid',
    no_mint Bool COMMENT 'Mint authority disabled',
    burnt_pct Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'LP burned %',
    rug_risk_pct Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Composite rug risk (0-100)',
    blacklist_risk_pct Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Blacklisted wallet holdings %',

    -- ════════════════════════════════════════════════════════════════════════
    -- TOKEN BLACKLIST (2 fields)
    -- ════════════════════════════════════════════════════════════════════════
    is_blacklisted Bool COMMENT 'Token flagged as malicious',
    blacklist_source Nullable(String) COMMENT 'Blacklist source: goplus, rugcheck, internal',

    -- ════════════════════════════════════════════════════════════════════════
    -- LIQUIDITY RISK (3 fields)
    -- ════════════════════════════════════════════════════════════════════════
    lp_lock_pct Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'LP locked %',
    lp_burn_pct Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'LP burned %',
    lp_removable Bool COMMENT 'Deployer can remove LP',

    -- ════════════════════════════════════════════════════════════════════════
    -- CONTRACT RISK FLAGS (3 fields)
    -- ════════════════════════════════════════════════════════════════════════
    has_freeze_authority Bool COMMENT 'Token can freeze wallets',
    has_mint_authority Bool COMMENT 'Creator can mint more',
    is_honeypot Bool COMMENT 'Honeypot detected',

    -- ════════════════════════════════════════════════════════════════════════
    -- FEE TRACKING (6 fields)
    -- ════════════════════════════════════════════════════════════════════════
    total_transaction_fees_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    total_priority_fees_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    total_dex_fees_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    total_validator_tips_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    total_platform_fees_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    total_fees_paid_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),

    -- ════════════════════════════════════════════════════════════════════════
    -- PRO TRADER METRICS (5 fields)
    -- ════════════════════════════════════════════════════════════════════════
    total_trader_count UInt64 CODEC(T64, LZ4) COMMENT 'All unique traders',
    pro_trader_count UInt64 CODEC(T64, LZ4) COMMENT 'Platform users',
    pro_trader_pct Decimal(38, 18) CODEC(Gorilla, LZ4) COMMENT 'Pro trader %',
    platforms_used Array(String) COMMENT 'Platform names used',
    platform_trader_counts Array(UInt64) COMMENT 'Traders per platform',

    -- ════════════════════════════════════════════════════════════════════════
    -- 5-MINUTE ROLLING STATS (11 fields)
    -- ════════════════════════════════════════════════════════════════════════
    stats_5m_price_change_pct Decimal(38, 18) CODEC(Gorilla, LZ4),
    stats_5m_volume_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_5m_volume_usd Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_5m_buys_count UInt64 CODEC(T64, LZ4),
    stats_5m_buys_volume_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_5m_buys_volume_usd Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_5m_sells_count UInt64 CODEC(T64, LZ4),
    stats_5m_sells_volume_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_5m_sells_volume_usd Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_5m_net_volume_sol Decimal(38, 18) CODEC(Gorilla, LZ4),
    stats_5m_net_volume_usd Decimal(38, 18) CODEC(Gorilla, LZ4),

    -- ════════════════════════════════════════════════════════════════════════
    -- 1-HOUR ROLLING STATS (11 fields)
    -- ════════════════════════════════════════════════════════════════════════
    stats_1h_price_change_pct Decimal(38, 18) CODEC(Gorilla, LZ4),
    stats_1h_volume_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_1h_volume_usd Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_1h_buys_count UInt64 CODEC(T64, LZ4),
    stats_1h_buys_volume_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_1h_buys_volume_usd Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_1h_sells_count UInt64 CODEC(T64, LZ4),
    stats_1h_sells_volume_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_1h_sells_volume_usd Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_1h_net_volume_sol Decimal(38, 18) CODEC(Gorilla, LZ4),
    stats_1h_net_volume_usd Decimal(38, 18) CODEC(Gorilla, LZ4),

    -- ════════════════════════════════════════════════════════════════════════
    -- 6-HOUR ROLLING STATS (11 fields)
    -- ════════════════════════════════════════════════════════════════════════
    stats_6h_price_change_pct Decimal(38, 18) CODEC(Gorilla, LZ4),
    stats_6h_volume_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_6h_volume_usd Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_6h_buys_count UInt64 CODEC(T64, LZ4),
    stats_6h_buys_volume_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_6h_buys_volume_usd Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_6h_sells_count UInt64 CODEC(T64, LZ4),
    stats_6h_sells_volume_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_6h_sells_volume_usd Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_6h_net_volume_sol Decimal(38, 18) CODEC(Gorilla, LZ4),
    stats_6h_net_volume_usd Decimal(38, 18) CODEC(Gorilla, LZ4),

    -- ════════════════════════════════════════════════════════════════════════
    -- 24-HOUR ROLLING STATS (11 fields)
    -- ════════════════════════════════════════════════════════════════════════
    stats_24h_price_change_pct Decimal(38, 18) CODEC(Gorilla, LZ4),
    stats_24h_volume_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_24h_volume_usd Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_24h_buys_count UInt64 CODEC(T64, LZ4),
    stats_24h_buys_volume_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_24h_buys_volume_usd Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_24h_sells_count UInt64 CODEC(T64, LZ4),
    stats_24h_sells_volume_sol Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_24h_sells_volume_usd Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_24h_net_volume_sol Decimal(38, 18) CODEC(Gorilla, LZ4),
    stats_24h_net_volume_usd Decimal(38, 18) CODEC(Gorilla, LZ4),

    -- ════════════════════════════════════════════════════════════════════════
    -- TIMESTAMP
    -- ════════════════════════════════════════════════════════════════════════
    last_updated DateTime64(9) CODEC(Delta, ZSTD(3)) COMMENT 'Last update time',

    -- ════════════════════════════════════════════════════════════════════════
    -- CLICKHOUSE ADDITIONS
    -- ════════════════════════════════════════════════════════════════════════
    version UInt64 MATERIALIZED toUnixTimestamp64Nano(last_updated)
        COMMENT 'Version for ReplacingMergeTree deduplication',

    -- Data skipping indexes
    INDEX idx_symbol token_symbol TYPE tokenbf_v1(10240, 3, 0) GRANULARITY 4,
    INDEX idx_dex primary_dex TYPE set(20) GRANULARITY 1,
    INDEX idx_mcap market_cap_usd TYPE minmax GRANULARITY 1,
    INDEX idx_volume stats_24h_volume_usd TYPE minmax GRANULARITY 1,
    INDEX idx_rug_risk rug_risk_pct TYPE minmax GRANULARITY 1
)
ENGINE = ReplicatedReplacingMergeTree(
    '/clickhouse/tables/{shard}/token_metrics',
    '{replica}',
    version
)
ORDER BY (token_mint)
COMMENT 'Current token metrics with 89 fields. Updated on every 1h OHLCV candle. ~10K active tokens.'
SETTINGS index_granularity = 8192;


-- ════════════════════════════════════════════════════════════════════════════
-- TOKEN METRICS - HISTORY
-- Purpose: Historical snapshots for time-series analysis
-- Engine: MergeTree (keeps all rows)
-- ════════════════════════════════════════════════════════════════════════════

CREATE TABLE datastreams.token_metrics_history ON CLUSTER '{cluster}'
(
    -- Subset of fields for history (saves storage)
    token_mint String CODEC(ZSTD(3)),
    token_symbol String CODEC(ZSTD(3)),
    price_sol Decimal(38, 18) CODEC(Gorilla, LZ4),
    price_usd Decimal(38, 18) CODEC(Gorilla, LZ4),
    market_cap_usd Decimal(38, 18) CODEC(Gorilla, LZ4),
    liquidity_usd Decimal(38, 18) CODEC(Gorilla, LZ4),
    holders_count UInt64 CODEC(T64, LZ4),
    top10_holdings_pct Decimal(38, 18) CODEC(Gorilla, LZ4),
    bundler_pct Decimal(38, 18) CODEC(Gorilla, LZ4),
    snipers_pct Decimal(38, 18) CODEC(Gorilla, LZ4),
    insiders_pct Decimal(38, 18) CODEC(Gorilla, LZ4),
    rug_risk_pct Decimal(38, 18) CODEC(Gorilla, LZ4),
    stats_24h_volume_usd Decimal(38, 18) CODEC(DoubleDelta, ZSTD(1)),
    stats_24h_price_change_pct Decimal(38, 18) CODEC(Gorilla, LZ4),
    last_updated DateTime64(9) CODEC(Delta, ZSTD(3)),

    INDEX idx_token token_mint TYPE bloom_filter GRANULARITY 4
)
ENGINE = ReplicatedMergeTree(
    '/clickhouse/tables/{shard}/token_metrics_history',
    '{replica}'
)
PARTITION BY toYYYYMMDD(last_updated)
ORDER BY (token_mint, last_updated)
TTL
    last_updated + INTERVAL 30 DAY TO VOLUME 'warm',
    last_updated + INTERVAL 90 DAY DELETE
COMMENT 'Historical token metrics snapshots. TTL: 90 days. ~21M rows at steady state.'
SETTINGS
    index_granularity = 8192,
    storage_policy = 'tiered',
    ttl_only_drop_parts = 1;
```

---

## Query Patterns & Performance

### Get Token Metrics (Single Token)

```sql
-- < 10ms
SELECT * FROM token_metrics FINAL
WHERE token_mint = 'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263';
```

### Top Gainers (24h)

```sql
-- < 50ms
SELECT
    token_symbol,
    price_usd,
    market_cap_usd,
    stats_24h_price_change_pct,
    stats_24h_volume_usd,
    holders_count
FROM token_metrics FINAL
WHERE stats_24h_volume_usd > 50000
  AND market_cap_usd > 100000
ORDER BY stats_24h_price_change_pct DESC
LIMIT 20;
```

### High Risk Tokens

```sql
-- Tokens with significant risk indicators
SELECT
    token_symbol,
    price_usd,
    rug_risk_pct,
    bundler_pct,
    snipers_pct,
    insiders_pct,
    top10_holdings_pct,
    has_mint_authority,
    has_freeze_authority,
    is_honeypot
FROM token_metrics FINAL
WHERE rug_risk_pct > 50
   OR bundler_pct > 20
   OR snipers_pct > 30
   OR is_honeypot = true
ORDER BY rug_risk_pct DESC;
```

### Pro Trader Analysis

```sql
-- Tokens with high smart money interest
SELECT
    token_symbol,
    market_cap_usd,
    stats_24h_volume_usd,
    total_trader_count,
    pro_trader_count,
    pro_trader_pct,
    arrayStringConcat(platforms_used, ', ') AS platforms
FROM token_metrics FINAL
WHERE pro_trader_pct > 30
  AND stats_24h_volume_usd > 100000
ORDER BY pro_trader_pct DESC
LIMIT 20;
```

### Holder Growth Analysis (History Table)

```sql
-- Holder growth over last 24 hours
SELECT
    token_mint,
    token_symbol,
    min(holders_count) AS holders_24h_ago,
    max(holders_count) AS holders_now,
    max(holders_count) - min(holders_count) AS holder_growth,
    (max(holders_count) - min(holders_count)) * 100.0 / min(holders_count) AS growth_pct
FROM token_metrics_history
WHERE last_updated >= now() - INTERVAL 24 HOUR
GROUP BY token_mint, token_symbol
HAVING min(holders_count) > 100
ORDER BY growth_pct DESC
LIMIT 20;
```

---

## Metrics Summary

### Total Field Count: 89

| Category | Fields | Key Metrics |
|----------|--------|-------------|
| Basic Info | 3 | token_mint, name, symbol |
| Market Data | 7 | price, market_cap, liquidity, supply |
| Primary Market | 2 | primary_market, primary_dex |
| Holder Metrics | 3 | top10_pct, holders_count, dev_pct |
| Risk Wallets | 7 | bundler, sniper, insider (pct + arrays) |
| Token Risk Flags | 5 | rug_risk, blacklist, no_mint, etc. |
| Token Blacklist | 2 | is_blacklisted, source |
| Liquidity Risk | 3 | lp_lock, lp_burn, lp_removable |
| Contract Risk | 3 | freeze, mint, honeypot |
| Fee Tracking | 6 | All fee categories |
| Pro Traders | 5 | Counts, percentages, platforms |
| 5m Stats | 11 | Rolling window metrics |
| 1h Stats | 11 | Rolling window metrics |
| 6h Stats | 11 | Rolling window metrics |
| 24h Stats | 11 | Rolling window metrics |
| Timestamp | 1 | last_updated |

### ClickHouse Optimizations Applied

| Optimization | Application |
|--------------|-------------|
| ReplacingMergeTree | Latest state per token |
| Version column | Nanosecond timestamp deduplication |
| LowCardinality | DEX names (~20 values) |
| Gorilla codec | Price/decimal fields |
| DoubleDelta codec | Volume fields |
| T64 codec | Count fields |
| Data skipping indexes | Symbol search, range filters |
| Dual-table pattern | Current state + history |

---

## What's Next

**Part 4: Position Tracking, FIFO PnL & ReplacingMergeTree** covers:
- Position state management per trader-token pair
- FIFO-based PnL calculations
- Cost basis tracking
- Fee accumulation per position
- Unrealized PnL computation with price joins

---

## Implementation References

| Document | Content |
|----------|---------|
| [09_TOKEN_METRICS_SETUP.md](./09_TOKEN_METRICS_SETUP.md) | Complete TokenMetric DDL |
| [27_RISK_SCORE_METHODOLOGY.md](./27_RISK_SCORE_METHODOLOGY.md) | Risk calculation details |
| [26_EXTERNAL_DATA_SOURCES.md](./26_EXTERNAL_DATA_SOURCES.md) | GoPlus, RugCheck integration |

---

*Part 3 of 6 in the "Building Real-Time Solana DEX Analytics with ClickHouse" series.*
